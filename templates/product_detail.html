{% extends "base.html" %}
{% block title %}{{ product.name }} | WASTED{% endblock %}

{% block content %}
<section class="pd-wrap">
    <!-- LEFT: main image -->
    <div class="pd-left">
        <img id="pdMainImage" class="pd-image"
            src="{% if images and images|length > 0 %}{{ url_for('product_image_by_id', image_id=images[0].id) }}{% else %}{{ url_for('product_image', product_id=product.id) }}{% endif %}"
            alt="{{ product.name }}">
    </div>

    <!-- RIGHT: info -->
    <div class="pd-right">
        <h1 class="pd-name">{{ product.name }}</h1>

        <div class="pd-price">
            KRW {{ "{:,}".format(product.price) }}
        </div>

        <!-- COLOR: 업로드한 이미지 개수만큼 -->
        {% if images and images|length > 0 %}
        <div class="pd-section">
            <div class="pd-label">COLOR</div>
            <div class="pd-colors" id="pdColors">
                {% for img in images %}
                <button type="button" class="pd-color {% if loop.first %}active{% endif %}"
                    data-img-url="{{ url_for('product_image_by_id', image_id=img.id) }}"
                    aria-label="color {{ loop.index }}">
                    <img src="{{ url_for('product_image_by_id', image_id=img.id) }}" alt="">
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- SIZE: variants(stock)로 disabled 결정 -->
        <div class="pd-section">
            <div class="pd-label">SIZE</div>

            <div class="pd-sizes" id="pdSizes">
                {% if variants and variants|length > 0 %}
                {% for v in variants %}
                {% set is_out = (v.stock|int <= 0) %} <button type="button"
                    class="pd-size {% if is_out %}is-disabled{% endif %}" {% if is_out %}disabled{% endif %}
                    data-size="{{ v.size }}" data-stock="{{ v.stock }}">
                    {{ v.size }}
                    </button>
                    {% endfor %}
                    {% else %}
                    <div class="pd-helper">사이즈 정보가 없습니다.</div>
                    {% endif %}
            </div>
        </div>

        <!-- 버튼 -->
        <div class="pd-actions">
            <button class="pd-btn" id="pdBuyBtn" disabled>사이즈를 선택하세요</button>
        </div>

        {% if product.description %}
        <div class="pd-desc">
            {{ product.description }}
        </div>
        {% endif %}
    </div>
</section>

<script>
    // COLOR 클릭 -> 메인 이미지 변경 + active 표시
    const colors = document.getElementById("pdColors");
    const mainImg = document.getElementById("pdMainImage");

    if (colors && mainImg) {
        colors.addEventListener("click", (e) => {
            const btn = e.target.closest(".pd-color");
            if (!btn) return;

            const url = btn.dataset.imgUrl;
            if (url) mainImg.src = url;

            colors.querySelectorAll(".pd-color").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    }

    // SIZE 클릭 -> 선택 유지(is-selected) + 구매 버튼 활성화
    const sizes = document.getElementById("pdSizes");
    const buyBtn = document.getElementById("pdBuyBtn");

    if (sizes && buyBtn) {
        sizes.addEventListener("click", (e) => {
            const btn = e.target.closest(".pd-size");
            if (!btn) return;

            if (btn.disabled) return; // 품절이면 클릭 안됨

            sizes.querySelectorAll(".pd-size").forEach(b => b.classList.remove("is-selected"));
            btn.classList.add("is-selected");

            const size = btn.dataset.size || "";
            buyBtn.disabled = false;
            buyBtn.textContent = size ? `${size} 구매하기` : "구매하기";
        });
    }
</script>
{% endblock %}