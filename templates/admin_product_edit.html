{% extends "base.html" %}
{% block title %}ADMIN | EDIT PRODUCT{% endblock %}

{% block content %}
<section class="admin-form-wrap">
    <h1 class="admin-title">상품 수정 (ID: {{ product.id }})</h1>

    <form method="post" enctype="multipart/form-data" class="admin-form">
        <label class="admin-label">
            상품명
            <input type="text" name="name" required class="admin-input" value="{{ product.name }}">
        </label>

        <label class="admin-label">
            가격 (숫자, KRW)
            <input type="number" name="price" min="0" step="1000" class="admin-input" value="{{ product.price }}">
        </label>

        <label class="admin-label">
            새 이미지 추가 업로드 (여러 장 가능)
            <input type="file" name="images" multiple accept="image/*" class="admin-input">
            <div class="admin-hint">컬러 대표 이미지에는 “이미지 ID(숫자)”를 입력합니다.</div>

            {# (선택) 실수 방지용: 현재 이미지 ID 보여주기 #}
            {% if images %}
            <div class="admin-hint">
                현재 이미지 ID:
                {% for img in images %}
                <span style="display:inline-block; margin-right:8px;">{{ img.id }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </label>

        <label class="admin-label">
            카테고리
            <select name="category" class="admin-input">
                {% for c in categories %}
                <option value="{{ c }}" {% if c==product.category %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </label>

        <label class="admin-label">
            설명
            <textarea name="description" rows="5" class="admin-input">{{ product.description or "" }}</textarea>
        </label>

        <hr>

        <div class="admin-label" style="margin-top:6px;">컬러 / 사이즈별 재고</div>
        <div id="colorBlocks"></div>

        <button type="button" class="admin-secondary-button" onclick="addColorBlock()">
            + 컬러 추가
        </button>

        <div class="admin-form-actions">
            <a href="{{ url_for('admin_products') }}" class="admin-secondary-button">취소</a>
            <button type="submit" class="admin-button">저장</button>
        </div>
    </form>
</section>

<script>
    const DEFAULT_SIZES = ["S", "M", "L", "XL"];
    const EXISTING_COLORS = {{ colors| tojson }};
    let colorIndex = 0;

    function addColorBlock(prefill = { name: "", image_id: "", variants: [] }) {
        const box = document.getElementById("colorBlocks");
        const idx = colorIndex++;

        const wrap = document.createElement("div");
        wrap.className = "colorBlock";
        wrap.style.border = "1px solid #eee";
        wrap.style.padding = "10px";
        wrap.style.borderRadius = "6px";
        wrap.style.margin = "10px 0";

        wrap.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <input class="admin-input" name="color_name[]" placeholder="COLOR (예: BLACK)" value="${prefill.name || ""}">
        <input class="admin-input" name="color_image_id[]" placeholder="대표 이미지 ID (숫자)" value="${prefill.image_id || ""}" style="max-width:180px;">
        <button type="button" class="admin-delete-button" onclick="this.closest('.colorBlock').remove()">삭제</button>
      </div>

      <div style="font-size:0.8rem; color:#666; margin-bottom:6px;">사이즈 / 재고</div>
      <div class="variantRows"></div>

      <button type="button" class="admin-secondary-button" onclick="addVariantRow(this, ${idx})" style="margin-top:8px;">
        + 사이즈 추가
      </button>
    `;

        box.appendChild(wrap);

        const rows = wrap.querySelector(".variantRows");

        if (prefill.variants && prefill.variants.length > 0) {
            prefill.variants.forEach(v => {
                rows.appendChild(makeVariantRow(idx, (v.size || ""), (v.stock || 0)));
            });
        } else {
            DEFAULT_SIZES.forEach(s => rows.appendChild(makeVariantRow(idx, s, 0)));
        }
    }

    function makeVariantRow(idx, size, stock) {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.gap = "8px";
        row.style.marginBottom = "6px";
        row.innerHTML = `
      <input name="size_${idx}[]" class="admin-input" style="width:90px;" value="${String(size).toUpperCase()}" placeholder="사이즈">
      <input name="stock_${idx}[]" type="number" min="0" class="admin-input" style="width:140px;" value="${Number(stock) || 0}" placeholder="재고">
      <button type="button" onclick="this.parentElement.remove()">삭제</button>
    `;
        return row;
    }

    function addVariantRow(btn, idx) {
        const wrap = btn.closest(".colorBlock");
        const rows = wrap.querySelector(".variantRows");
        rows.appendChild(makeVariantRow(idx, "", 0));
    }

    if (EXISTING_COLORS && EXISTING_COLORS.length > 0) {
        EXISTING_COLORS.forEach(c => {
            addColorBlock({
                name: c.name,
                image_id: c.image_id,
                variants: c.variants || [],
            });
        });
    } else {
        addColorBlock();
    }
</script>
{% endblock %}