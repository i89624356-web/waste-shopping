{% extends "base.html" %}

{% block title %}ADMIN | PRODUCTS{% endblock %}

{% block content %}
<section class="admin-header">
    <h1 class="admin-title">ADMIN · PRODUCTS</h1>
    <a href="{{ url_for('admin_product_new') }}" class="admin-button">
        + 새 상품 추가
    </a>
</section>

<section class="admin-table-wrap">
    {% if products %}
    <table class="admin-table">
        <thead>
            <tr>
                <th style="width: 40px;">순서</th>
                <th style="width: 60px;">ID</th>
                <th>이미지</th>
                <th>이름</th>
                <th>카테고리</th>
                <th>상태</th>
                <th>가격</th>
                <th style="width: 160px;">관리</th>
            </tr>
        </thead>
        <tbody id="product-table-body">
            {% for p in products %}
            <tr data-product-id="{{ p.id }}">
                <td class="drag-cell">
                    <span class="drag-handle">≡</span>
                </td>
                <td>{{ p.id }}</td>
                <td>
                    <div class="admin-thumb">
                        <img src="{{ url_for('product_image', product_id=p.id) }}" alt="{{ p.name }}">
                    </div>
                </td>
                <td class="admin-text-cell">
                    {{ p.name }}
                </td>
                <td>{{ p.category }}</td>
                <td>{{ p.status }}</td>
                <td>KRW {{ "{:,}".format(p.price) }}</td>
                <td>
                    <div class="admin-actions">
                        <a href="{{ url_for('admin_product_edit', product_id=p.id) }}" class="admin-button">
                            수정
                        </a>
                        <form method="post" action="{{ url_for('admin_product_delete', product_id=p.id) }}"
                            onsubmit="return confirm('정말 삭제할까요?');">
                            <button type="submit" class="admin-delete-button">삭제</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>등록된 상품이 없습니다.</p>
    {% endif %}
</section>

{# SortableJS 로 드래그 정렬 구현 #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const tbody = document.getElementById("product-table-body");
    if (tbody) {
        new Sortable(tbody, {
            handle: ".drag-handle",
            animation: 150,
            onEnd: function () {
                const order = [];
                tbody.querySelectorAll("tr[data-product-id]").forEach(tr => {
                    order.push(tr.dataset.productId);
                });

                fetch("{{ url_for('admin_products_reorder') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({ order: order })
                }).then(resp => {
                    if (!resp.ok) {
                        alert("순서 저장에 실패했습니다.");
                    }
                }).catch(() => {
                    alert("순서 저장에 실패했습니다.");
                });
            }
        });
    }
</script>
{% endblock %}